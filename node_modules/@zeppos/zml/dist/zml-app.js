const e=Object.prototype.hasOwnProperty,t={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const s=t.handler.call(this,e,...t.args);"object"==typeof s&&this.mixins.push({handler:s,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:h})=>{Object.assign(e,o)}))}};let s=Buffer;function n(e){return"object"==typeof e&&!s.isBuffer(e)&&!Array.isArray(e)&&null!==e}let i=null;i="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let r=null;o()?r=hmApp.getPackageInfo:h()&&(r=i("@zos/app").getPackageInfo),o()?hmUI:h()&&i("@zos/ui"),o()?hmSetting.getDeviceInfo:h()&&i("@zos/device").getDeviceInfo,o()?"undefined"!=typeof __$$app$$__&&__$$app$$__:h()&&i("@zos/i18n").getText,o()?hmApp.gotoPage:h()&&i("@zos/router").push;let a=null;function o(){return l()&&d()}function h(){return l()&&p()}function d(){return"undefined"!=typeof hmApp}function p(){return"undefined"!=typeof __$$R$$__}function l(){return d()||p()}o()?a=hmBle:h()&&(a=i("@zos/ble"));let c=null;function u({globalData:e={},onCreate:t,onDestroy:s,...n}={}){const i={globalData:e,...n,onCreate(...e){for(let t=0;t<=u.mixins.length-1;t++){const s=u.mixins[t];s.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=u.mixins.length-1;t>=0;t--){const s=u.mixins[t];s.handler.onDestroy?.apply(this,e)}}};return u.handle(i),i}var f,y;o()?c=DeviceRuntimeCore.HmLogger:h()?c=i("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(c=Logger),f=u,y=t,Object.getOwnPropertyNames(y).forEach((function(t){if(!e.call(f,t)){var s=Object.getOwnPropertyDescriptor(y,t);Object.defineProperty(f,t,s)}})),u.init(),u.use((function(){return{onInit(){this.logger=c.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=c.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}}));class g{constructor(e){this.global=e}getValue(e){return this.global[e]}setValue(e,t){return this.global[e]=t}deleteKey(e){delete this.global[e]}}class I extends g{constructor(){super(__$$app$$__.__globals__.__scopedGlobals__)}}const T=i("@zos/utils").EventBus,m=i("@zos/timer").setTimeout,b=i("@zos/timer").clearTimeout,k=globalThis.Promise;function L(){const e={canceled:!1};return e.promise=new k((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function w(e){return E(function(e){return JSON.stringify(e)}(e))}function S(e){return t=U(e),JSON.parse(t);var t}function E(e){return s.from(e,"utf-8")}function U(e){return e.toString("utf-8")}function C(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function q(e){return t=function(e){return s.from(e)}(e),t.toString("hex");var t}const B=l()?c.getLogger("device-message"):c.getLogger("side-message"),v=void 0,x="json",_="text",P="bin";function D(e){switch(e.toLowerCase()){case x:return 2;case _:return 1;case P:return 3;case"empty":return 0;default:return 3}}let $=1e4;function O(){return $++}let j=1e3;function R(){return j++}class A extends T{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.chunks=[],this.count=-1,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId+1,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count!==this.chunks.length)return;if(!this.finishChunk)return;let e=[];for(let t=0;t<this.count;t++){const s=this.chunks[t];if(!s||s.seqId!==t)return e=null,this.releaseBuf(),void this.emit("error",Error("receive data error"));e.push(s.payload)}this.chunks=[],this.finishChunk.payload=s.concat(e),e=null,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`))}releaseBuf(){this.chunks=[],this.finishChunk=null,this.count=0}}class F{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new A(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const M={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class z extends Error{constructor(e,t){super(t),this.code=e}}class H extends T{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n=(l()?a:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:l()?a:void 0}){super(),this.isDevice=l(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new F,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=L(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=m((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(M.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&b(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return S(e)}json2Buf(e){return w(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=k.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=s.alloc(t),i=0;return n.writeUInt8(e.flag,i),i+=1,n.writeUInt8(e.version,i),i+=1,n.writeUInt16LE(e.type,i),i+=2,n.writeUInt16LE(e.port1,i),i+=2,n.writeUInt16LE(e.port2,i),i+=2,n.writeUInt32LE(e.appId,i),i+=4,n.writeUInt32LE(e.extra,i),i+=4,n.fill(e.payload,i,e.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:s.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:s.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=s.from(e);let n=0;const i=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const a=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const h=t.readUInt16LE(n);n+=2;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:d,extra:p,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=v){if(t&&B.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,q(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=v){t&&B.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,q(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=t.byteLength;let d=0;const p=s.alloc(o),l=e||O(),c=R();let u=0;const f=Math.ceil(h/o);function y(){return u++}for(let e=1;e<=f;e++){if(this.errorIfBleDisconnect(),e===f){const e=h-d,o=s.alloc(0+e);t.copy(o,0,d,d+e),d+=e,this.sendDataWithSession({traceId:l,spanId:c,seqId:y(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}t.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:l,spanId:c,seqId:y(),payload:p,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=w(t),a=e||O();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||O();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=E(t),a=e||O();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let l=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(l)}buildPayload(e){const t=66+e.payload.byteLength;let n=s.alloc(t),i=0;return n.writeUInt32LE(e.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(e.spanId,i),i+=4,n.writeUInt32LE(e.seqId,i),i+=4,n.writeUInt32LE(e.totalLength,i),i+=4,n.writeUInt32LE(e.payload.byteLength,i),i+=4,n.writeUInt8(e.type,i),i+=1,n.writeUInt8(e.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(e.contentType,i),i+=1,n.writeUInt8(e.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(e.payload,i,e.payload.byteLength+i),n}readPayload(e){const t=s.from(e);let n=0;const i=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt8(n);n+=1;const l=t.readUInt8(n);n+=1;const c=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const I=t.readUInt32LE(n);n+=4;const T=t.readUInt32LE(n);n+=4;const m=t.readUInt8(n);n+=1;const b=t.readUInt8(n);n+=1;const k=t.readUInt16LE(n);n+=2;const L=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:l,contentType:m,dataType:b,timestamp1:c,timestamp2:u,timestamp3:f,timestamp4:y,timestamp5:g,timestamp6:I,timestamp7:T,extra1:k,extra2:L,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(l()&&!this.ble.connectStatus())throw new z(M.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(l()&&!this.appSidePort)throw new z(M.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?D(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return k.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=P;"string"==typeof e?i=_:n(e)?i=x:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||s.isBuffer(e))&&(i=P);const r={timeout:6e4,contentType:i,dataType:i},a=O(),o=L();t=Object.assign(r,t);let h=m((()=>{h=null,o.reject(new z(M.TIMEOUT,"request timeout"))}),t.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=U(t);break;case 3:default:n=t;break;case 2:n=S(t)}o.resolve(n)})),s.isBuffer(e)?this.sendBuf({requestId:a,buf:e,type:1,contentType:3,dataType:D(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:a,buf:s.from(e),type:1,contentType:3,dataType:D(t.dataType)}):2===D(t.contentType)?this.sendJson({requestId:a,json:e,type:1,contentType:2,dataType:D(t.dataType)}):1===D(t.contentType)?this.sendText({requestId:a,text:e,type:1,contentType:1,dataType:D(t.dataType)}):this.sendBuf({requestId:a,buf:s.from(e),type:1,contentType:3,dataType:D(t.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(b(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:n(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||s.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>s.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:s.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:s.from(e),type:3,contentType:3,dataType:0})))}}c.getLogger("message-builder");const J="hmrpcv1";function V(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}const N=i("@zos/ble/TransferFile"),W=(K=N?new N:void 0,{canUseFileTransfer:()=>void 0!==K,onFile(e){return e&&this.canUseFileTransfer()?(K.inbox.on("newfile",(function(){const t=K.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e&&this.canUseFileTransfer()?(K.inbox.on("file",(function(){const t=K.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return K.inbox.emit("file"),this},offFile(){return this.canUseFileTransfer()?(K.inbox.off("newfile"),K.inbox.off("file"),this):this},getFile(){return this.canUseFileTransfer()?K.inbox.getNextFile():null},sendFile(e,t){if(!this.canUseFileTransfer())throw new Error("fileTransfer is not available");return K.outbox.enqueueFile(e,t)}});var K;u.use((function(e){(new I).setValue("_$mgr$_",{}),e.$m={}})).use((function(e){const t={shakeTimeout:5e3,requestTimeout:6e4,transport:s=new H({appId:r().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(s.on("call",(({contentType:t,payload:s})=>{switch(t){case 2:s=S(s);break;case 1:s=U(s);break;default:s=C(s)}e&&e(s)})),this):this},offOnCall(e){return s.off("call",e),this},call(e){return l()&&s.fork(this.shakeTimeout),e=n(e)?e.contentType?e:{jsonrpc:J,...e}:e,s.call(e)},onRequest(e){return e?(s.on("request",(t=>{let s=t.request.payload;switch(t.request.contentType){case 2:s=S(s);break;case 1:s=U(s);break;default:s=C(s)}e&&e(s,((e,n,i={})=>2===t.request.contentType&&s?.jsonrpc===J?e?t.response({data:{jsonrpc:J,error:e}}):t.response({data:{jsonrpc:J,result:n}}):t.response({data:n,...i})))})),this):this},cancelAllRequest(){return s.off("response"),this},offOnRequest(e){return s.off("request",e),this},request(e,t={}){return l()&&s.fork(this.shakeTimeout),e=n(e)?t.contentType?e:{jsonrpc:J,...e}:e,s.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!n(e)||e.jsonrpc!==J)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return s.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this},start(){return s.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this}};var s;return{onCreate(){this.messaging=this.globalData.messaging=t,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:V}})).use((function(e){return{onCreate(){W.onFile(this.onReceivedFile?.bind(this))},onDestroy(){W.offFile()},sendFile:(e,t)=>W.sendFile(e,t)}}));export{u as BaseApp};
