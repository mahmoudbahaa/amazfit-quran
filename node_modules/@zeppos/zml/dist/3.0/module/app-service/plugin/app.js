Buffer;let e=null;function s(){return i()&&r()}function t(){return i()&&n()}function r(){return"undefined"!=typeof hmApp}function n(){return"undefined"!=typeof __$$R$$__}function i(){return r()||n()}function o(e){if(!e||"object"!=typeof e)throw new Error("obj is required and must be an object");const s=[];for(let[t,r]of Object.entries(e))t=encodeURIComponent(t),Array.isArray(r)?r.forEach((e=>{s.push(`${t}[]=${encodeURIComponent(e)}`)})):s.push(`${t}=${encodeURIComponent(r)}`);return s.join("&")}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:t()&&e("@zos/app").getPackageInfo,s()?hmUI:t()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:t()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:t()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:t()&&e("@zos/router").push,s()?hmBle:t()&&e("@zos/ble"),e("@zos/utils").qs.parse;const{queryPermission:u,requestPermission:a}=e("@zos/app"),{showToast:c}=e("@zos/interaction");class l{static PermissionStatus={unauthorized:0,error:1,authorized:2};static RequestPermissionResult={cancel:0,error:1,granted:2};static request(e,s){const t=u({permissions:e})[0];switch(t){case l.PermissionStatus.unauthorized:a({permissions:e,callback([e]){switch(e){case l.RequestPermissionResult.granted:c({content:"permission: granted"}),s&&s({code:e});break;case l.RequestPermissionResult.cancel:c({content:"permission: canceled"}),s&&s({error:new Error(e)});break;default:c({content:"permission: request error"}),s&&s({error:new Error(e)})}}});break;case l.PermissionStatus.authorized:s&&s({code:t});break;default:c({content:"permission: query error"}),s&&s({error:new Error(t)})}}}const{showToast:h}=e("@zos/interaction"),{EventBus:g}=e("@zos/utils"),p=e("@zos/app-service"),_=["device:os.bg_service"];class f{constructor(e){this.url=e,this._onMessage=null,this.BgService=null}get onMessage(){return this._onMessage}set onMessage(e){e?(this._onMessage=e,this.BgService._eventBus.on("bgServiceMessage",this._onMessage)):(this._onMessage=null,this.BgService._eventBus.off("bgServiceMessage"))}get isRunning(){return p.getAllAppServices().includes(this.url)}postMessage(e){this.BgService._eventBus.emit("clientMessage",e)}postEvent(e,s){if(!e)return s({error:new Error("postEvent need params")});if(!this.isRunning)return this.start(e,s);const t=p.start({url:this.url,param:`_u=${this.url}&_s=m&_a=running&`+o(e),complete_func:e=>{if(!e.result)return h({content:"start service error"}),void(s&&s({error:new Error(e.file)}));s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}start(e,s){this.isRunning?this.postEvent(e,s):l.request(_,(t=>{t.error?s&&s(t):this._start(e,s)}))}_start(e,s){const t=p.start({url:this.url,param:`_u=${this.url}&_s=m&_a=start&`+o(e??{}),complete_func:e=>{if(!e.result)return h({content:"start service error"}),void(s&&s({error:new Error(e.file)}));h({content:"start service success"}),s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}stop(e,s){if(!this.isRunning)return void s({file:this.url});const t=p.stop({url:this.url,param:`_u=${this.url}&_s=m&_a=stop&`+o(e??{}),complete_func:e=>{if(!e.result)return h({content:`stop service[${this.url}] error`}),void(s&&s({error:new Error(e.file)}));s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}toString(){return`BgService {url=${this.url} status=${this.isRunning?"running":"stop"}}`}}class v{constructor(){this._instance=new Map,this._eventBus=new g,this._onMessage=null}instance(e){if(this._instance.has(e)){const s=this._instance.get(e);return s.BgService=this,s}const s=new f(e);return s.BgService=this,this._instance.set(e,s),s}postMessage(e){this._eventBus.emit("bgServiceMessage",e)}get onMessage(){return this._onMessage}set onMessage(e){e?(this._onMessage=e,this._eventBus.on("clientMessage",e)):(this._onMessage=null,this._eventBus.off("clientMessage"))}stopAll(){this._instance.forEach((e=>{e.stop()})),this._instance.clear()}offMessage(){this.onMessage=null}disposePage(){this._instance.forEach((e=>{e.onMessage=null,e.BgService=null})),this._instance.clear()}disposeService(){this.offMessage()}disposeApp(){this.disposePage(),this.disposeService()}}function d(e){return e.$m.BgService=new v,{onDestroy(){e.$m.BgService.disposeApp()}}}const m=__API_LEVEL__;export{m as API_LEVEL,d as appPlugin};
