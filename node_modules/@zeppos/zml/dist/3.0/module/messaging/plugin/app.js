let e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let s=null;s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let n=null;i()?n=hmApp.getPackageInfo:a()&&(n=s("@zos/app").getPackageInfo),i()?hmUI:a()&&s("@zos/ui"),i()?hmSetting.getDeviceInfo:a()&&s("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__:a()&&s("@zos/i18n").getText,i()?hmApp.gotoPage:a()&&s("@zos/router").push;let r=null;function i(){return d()&&o()}function a(){return d()&&h()}function o(){return"undefined"!=typeof hmApp}function h(){return"undefined"!=typeof __$$R$$__}function d(){return o()||h()}i()?r=hmBle:a()&&(r=s("@zos/ble"));let p=null;i()?p=DeviceRuntimeCore.HmLogger:a()?p=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(p=Logger);const c=s("@zos/utils").EventBus,u=s("@zos/timer").setTimeout,l=s("@zos/timer").clearTimeout,y=globalThis.Promise;function f(){const e={canceled:!1};return e.promise=new y((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function g(e){return T(function(e){return JSON.stringify(e)}(e))}function I(e){return t=m(e),JSON.parse(t);var t}function T(t){return e.from(t,"utf-8")}function m(e){return e.toString("utf-8")}function k(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function L(t){return s=function(t){return e.from(t)}(t),s.toString("hex");var s}const b=d()?p.getLogger("device-message"):p.getLogger("side-message"),S=void 0,w="json",E="text",U="bin",q=0,B=1,C=2,v=3;function P(e){switch(e.toLowerCase()){case w:return C;case E:return B;case U:return v;case"empty":return q;default:return v}}let _=1e4;function D(){return _++}let $=1e3;function x(){return $++}class A extends c{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.chunks=[],this.count=-1,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId+1,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count!==this.chunks.length)return;if(!this.finishChunk)return;let t=[];for(let e=0;e<this.count;e++){const s=this.chunks[e];if(!s||s.seqId!==e)return t=null,this.releaseBuf(),void this.emit("error",Error("receive data error"));t.push(s.payload)}this.chunks=[],this.finishChunk.payload=e.concat(t),t=null,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`))}releaseBuf(){this.chunks=[],this.finishChunk=null,this.count=0}}class R{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new A(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const M={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class z extends Error{constructor(e,t){super(t),this.code=e}}class O extends c{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n=(d()?r:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:d()?r:void 0}){super(),this.isDevice=d(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new R,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=f(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=u((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(M.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&l(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return I(e)}json2Buf(e){return g(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=y.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const s=this.getMessageHeaderSize()+t.payload.byteLength;let n=e.alloc(s),r=0;return n.writeUInt8(t.flag,r),r+=1,n.writeUInt8(t.version,r),r+=1,n.writeUInt16LE(t.type,r),r+=2,n.writeUInt16LE(t.port1,r),r+=2,n.writeUInt16LE(t.port2,r),r+=2,n.writeUInt32LE(t.appId,r),r+=4,n.writeUInt32LE(t.extra,r),r+=4,n.fill(t.payload,r,t.payload.byteLength+r),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const s=e.from(t);let n=0;const r=s.readUInt8(n);n+=1;const i=s.readUInt8(n);n+=1;const a=s.readUInt16LE(n);n+=2;const o=s.readUInt16LE(n);n+=2;const h=s.readUInt16LE(n);n+=2;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt32LE(n);return n+=4,{flag:r,version:i,type:a,port1:o,port2:h,appId:d,extra:p,payload:s.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=S){if(t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=S){t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:s,type:n,contentType:r,dataType:i},{messageType:a=4}={}){const o=3518,h=s.byteLength;let d=0;const p=e.alloc(o),c=t||D(),u=x();let l=0;const y=Math.ceil(h/o);function f(){return l++}for(let t=1;t<=y;t++){if(this.errorIfBleDisconnect(),t===y){const t=h-d,o=e.alloc(0+t);s.copy(o,0,d,d+t),d+=t,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:o,type:n,opCode:1,totalLength:h,contentType:r,dataType:i},{messageType:a});break}s.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:p,type:n,opCode:0,totalLength:h,contentType:r,dataType:i},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:r}){const i=g(t),a=e||D();this.sendHmProtocol({requestId:a,dataBin:i,type:s,contentType:n,dataType:r})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:r}){const i=e||D();return this.sendHmProtocol({requestId:i,dataBin:t,type:s,contentType:n,dataType:r})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:r}){const i=T(t),a=e||D();return this.sendHmProtocol({requestId:a,dataBin:i,type:s,contentType:n,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:r,opCode:i,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:r,opCode:i,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(t){const s=66+t.payload.byteLength;let n=e.alloc(s),r=0;return n.writeUInt32LE(t.traceId,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(t.spanId,r),r+=4,n.writeUInt32LE(t.seqId,r),r+=4,n.writeUInt32LE(t.totalLength,r),r+=4,n.writeUInt32LE(t.payload.byteLength,r),r+=4,n.writeUInt8(t.type,r),r+=1,n.writeUInt8(t.opCode,r),r+=1,n.writeUInt32LE(this.now(),r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.writeUInt8(t.contentType,r),r+=1,n.writeUInt8(t.dataType,r),r+=1,n.writeUInt16LE(0,r),r+=2,n.writeUInt32LE(0,r),r+=4,n.writeUInt32LE(0,r),r+=4,n.fill(t.payload,r,t.payload.byteLength+r),n}readPayload(t){const s=e.from(t);let n=0;const r=s.readUInt32LE(n);n+=4;const i=s.readUInt32LE(n);n+=4;const a=s.readUInt32LE(n);n+=4;const o=s.readUInt32LE(n);n+=4;const h=s.readUInt32LE(n);n+=4;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt8(n);n+=1;const c=s.readUInt8(n);n+=1;const u=s.readUInt32LE(n);n+=4;const l=s.readUInt32LE(n);n+=4;const y=s.readUInt32LE(n);n+=4;const f=s.readUInt32LE(n);n+=4;const g=s.readUInt32LE(n);n+=4;const I=s.readUInt32LE(n);n+=4;const T=s.readUInt32LE(n);n+=4;const m=s.readUInt8(n);n+=1;const k=s.readUInt8(n);n+=1;const L=s.readUInt16LE(n);n+=2;const b=s.readUInt32LE(n);n+=4;const S=s.readUInt32LE(n);return n+=4,{traceId:r,parentId:i,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:m,dataType:k,timestamp1:u,timestamp2:l,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:T,extra1:L,extra2:b,extra3:S,payload:s.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(d()&&!this.ble.connectStatus())throw new z(M.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(d()&&!this.appSidePort)throw new z(M.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?P(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(s,n){try{this.errorIfBleDisconnect()}catch(e){return y.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let r=U;"string"==typeof s?r=E:t(s)?r=w:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(r=U);const i={timeout:6e4,contentType:r,dataType:r},a=D(),o=f();n=Object.assign(i,n);let h=u((()=>{h=null,o.reject(new z(M.TIMEOUT,"request timeout"))}),n.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case B:n=m(t);break;case v:n=t;break;case C:n=I(t);break;default:n=t}o.resolve(n)})),e.isBuffer(s)?this.sendBuf({requestId:a,buf:s,type:1,contentType:v,dataType:P(n.dataType)}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:v,dataType:P(n.dataType)}):P(n.contentType)===C?this.sendJson({requestId:a,json:s,type:1,contentType:C,dataType:P(n.dataType)}):P(n.contentType)===B?this.sendText({requestId:a,text:s,type:1,contentType:B,dataType:P(n.dataType)}):this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:v,dataType:P(n.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(l(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){v===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):B===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):C===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:v})}call(s){let n=C;return"string"==typeof s?n=B:t(s)?n=C:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(n=v),this.waitingShakePromise.then((()=>e.isBuffer(s)?this.sendBuf({buf:s,type:3,contentType:v,dataType:q}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({buf:e.from(s),type:3,contentType:v,dataType:q}):n===C?this.sendJson({json:s,type:3,contentType:C,dataType:q}):n===B?this.sendText({text:s,type:3,contentType:B,dataType:q}):this.sendBuf({buf:e.from(s),type:3,contentType:v,dataType:q})))}}p.getLogger("message-builder");const j="hmrpcv1";function H(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function J(e){const s={shakeTimeout:5e3,requestTimeout:6e4,transport:r=new O({appId:n().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(r.on("call",(({contentType:t,payload:s})=>{switch(t){case C:s=I(s);break;case B:s=m(s);break;default:s=k(s)}e&&e(s)})),this):this},offOnCall(e){return r.off("call",e),this},call(e){return d()&&r.fork(this.shakeTimeout),e=t(e)?e.contentType?e:{jsonrpc:j,...e}:e,r.call(e)},onRequest(e){return e?(r.on("request",(t=>{let s=t.request.payload;switch(t.request.contentType){case C:s=I(s);break;case B:s=m(s);break;default:s=k(s)}e&&e(s,((e,n,r={})=>t.request.contentType===C&&s?.jsonrpc===j?e?t.response({data:{jsonrpc:j,error:e}}):t.response({data:{jsonrpc:j,result:n}}):t.response({data:n,...r})))})),this):this},cancelAllRequest(){return r.off("response"),this},offOnRequest(e){return r.off("request",e),this},request(e,s={}){return d()&&r.fork(this.shakeTimeout),e=t(e)?s.contentType?e:{jsonrpc:j,...e}:e,r.request(e,{timeout:this.requestTimeout,...s}).then((e=>{if(!t(e)||e.jsonrpc!==j)return e;const{error:s,result:n}=e;if(s)throw s;return n}))},connect(){return r.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),r.disConnect((()=>{})),this},start(){return r.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),r.disConnect((()=>{})),this}};var r;return{onCreate(){this.messaging=this.globalData.messaging=s,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:H}}const W="3.0";export{W as API_LEVEL,J as appPlugin};
