const e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let s=null;s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},i()?hmApp.getPackageInfo:r()&&s("@zos/app").getPackageInfo,i()?hmUI:r()&&s("@zos/ui"),i()?hmSetting.getDeviceInfo:r()&&s("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__:r()&&s("@zos/i18n").getText,i()?hmApp.gotoPage:r()&&s("@zos/router").push;let n=null;function i(){return h()&&a()}function r(){return h()&&o()}function a(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function h(){return a()||o()}i()?n=hmBle:r()&&(n=s("@zos/ble"));let d=null;i()?d=DeviceRuntimeCore.HmLogger:r()?d=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);class p{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,u=clearTimeout,l=Promise;function y(){const e={canceled:!1};return e.promise=new l((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e){return I(function(e){return JSON.stringify(e)}(e))}function g(e){return t=T(e),JSON.parse(t);var t}function I(t){return e.from(t,"utf-8")}function T(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function L(t){return s=function(t){return e.from(t)}(t),s.toString("hex");var s}const k=h()?d.getLogger("device-message"):d.getLogger("side-message"),b=void 0,S="json",w="text",E="bin";function U(e){switch(e.toLowerCase()){case S:return 2;case w:return 1;case E:return 3;case"empty":return 0;default:return 3}}let q=1e4;function C(){return q++}let B=1e3;function _(){return B++}class v extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.chunks=[],this.count=-1,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId+1,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count!==this.chunks.length)return;if(!this.finishChunk)return;let t=[];for(let e=0;e<this.count;e++){const s=this.chunks[e];if(!s||s.seqId!==e)return t=null,this.releaseBuf(),void this.emit("error",Error("receive data error"));t.push(s.payload)}this.chunks=[],this.finishChunk.payload=e.concat(t),t=null,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`))}releaseBuf(){this.chunks=[],this.finishChunk=null,this.count=0}}class P{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new v(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const R={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class D extends Error{constructor(e,t){super(t),this.code=e}}d.getLogger("message-builder");const x="hmrpcv1",$=new class extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:i=(h()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:h()?n:void 0}){super(),this.isDevice=h(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new P,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=y(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new D(R.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=l.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const s=this.getMessageHeaderSize()+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt8(t.flag,i),i+=1,n.writeUInt8(t.version,i),i+=1,n.writeUInt16LE(t.type,i),i+=2,n.writeUInt16LE(t.port1,i),i+=2,n.writeUInt16LE(t.port2,i),i+=2,n.writeUInt32LE(t.appId,i),i+=4,n.writeUInt32LE(t.extra,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const s=e.from(t);let n=0;const i=s.readUInt8(n);n+=1;const r=s.readUInt8(n);n+=1;const a=s.readUInt16LE(n);n+=2;const o=s.readUInt16LE(n);n+=2;const h=s.readUInt16LE(n);n+=2;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:d,extra:p,payload:s.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=b){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=b){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:s,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=s.byteLength;let d=0;const p=e.alloc(o),c=t||C(),u=_();let l=0;const y=Math.ceil(h/o);function f(){return l++}for(let t=1;t<=y;t++){if(this.errorIfBleDisconnect(),t===y){const t=h-d,o=e.alloc(0+t);s.copy(o,0,d,d+t),d+=t,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}s.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:p,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||C();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||C();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=I(t),a=e||C();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(t){const s=66+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt32LE(t.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(t.spanId,i),i+=4,n.writeUInt32LE(t.seqId,i),i+=4,n.writeUInt32LE(t.totalLength,i),i+=4,n.writeUInt32LE(t.payload.byteLength,i),i+=4,n.writeUInt8(t.type,i),i+=1,n.writeUInt8(t.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(t.contentType,i),i+=1,n.writeUInt8(t.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}readPayload(t){const s=e.from(t);let n=0;const i=s.readUInt32LE(n);n+=4;const r=s.readUInt32LE(n);n+=4;const a=s.readUInt32LE(n);n+=4;const o=s.readUInt32LE(n);n+=4;const h=s.readUInt32LE(n);n+=4;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt8(n);n+=1;const c=s.readUInt8(n);n+=1;const u=s.readUInt32LE(n);n+=4;const l=s.readUInt32LE(n);n+=4;const y=s.readUInt32LE(n);n+=4;const f=s.readUInt32LE(n);n+=4;const g=s.readUInt32LE(n);n+=4;const I=s.readUInt32LE(n);n+=4;const T=s.readUInt32LE(n);n+=4;const m=s.readUInt8(n);n+=1;const L=s.readUInt8(n);n+=1;const k=s.readUInt16LE(n);n+=2;const b=s.readUInt32LE(n);n+=4;const S=s.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:m,dataType:L,timestamp1:u,timestamp2:l,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:T,extra1:k,extra2:b,extra3:S,payload:s.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(h()&&!this.ble.connectStatus())throw new D(R.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(h()&&!this.appSidePort)throw new D(R.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?U(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(s,n){try{this.errorIfBleDisconnect()}catch(e){return l.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=E;"string"==typeof s?i=w:t(s)?i=S:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(i=E);const r={timeout:6e4,contentType:i,dataType:i},a=C(),o=y();n=Object.assign(r,n);let h=c((()=>{h=null,o.reject(new D(R.TIMEOUT,"request timeout"))}),n.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=T(t);break;case 3:default:n=t;break;case 2:n=g(t)}o.resolve(n)})),e.isBuffer(s)?this.sendBuf({requestId:a,buf:s,type:1,contentType:3,dataType:U(n.dataType)}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:U(n.dataType)}):2===U(n.contentType)?this.sendJson({requestId:a,json:s,type:1,contentType:2,dataType:U(n.dataType)}):1===U(n.contentType)?this.sendText({requestId:a,text:s,type:1,contentType:1,dataType:U(n.dataType)}):this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:U(n.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(u(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(s){let n=2;return"string"==typeof s?n=1:t(s)?n=2:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(n=3),this.waitingShakePromise.then((()=>e.isBuffer(s)?this.sendBuf({buf:s,type:3,contentType:3,dataType:0}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0}):2===n?this.sendJson({json:s,type:3,contentType:2,dataType:0}):1===n?this.sendText({text:s,type:3,contentType:1,dataType:0}):this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0})))}},A=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(s){return h()&&e.fork(this.shakeTimeout),s=t(s)?s.contentType?s:{jsonrpc:x,...s}:s,e.call(s)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===x?t?e.response({data:{jsonrpc:x,error:t}}):e.response({data:{jsonrpc:x,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(s,n={}){return h()&&e.fork(this.shakeTimeout),s=t(s)?n.contentType?s:{jsonrpc:x,...s}:s,e.request(s,{timeout:this.requestTimeout,...n}).then((e=>{if(!t(e)||e.jsonrpc!==x)return e;const{error:s,result:n}=e;if(s)throw s;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function M(){return{onInit(){this.messaging=A,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const O="3.0";export{O as API_LEVEL,M as messagingPlugin};
